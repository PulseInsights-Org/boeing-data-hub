name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  EC2_HOST: 98.84.57.169
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/boeing-data-hub/backend

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to EC2
        run: |
          # Sync backend code to EC2 (excluding unnecessary files)
          rsync -avz --delete \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'venv' \
            --exclude '.git' \
            --exclude 'celerybeat-schedule*' \
            --exclude 'tests' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./backend/ \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Install dependencies and restart services
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/boeing-data-hub/backend

            # Activate virtual environment and install dependencies
            source venv/bin/activate
            pip install -r requirements.txt --quiet

            # Restart all three services
            sudo systemctl restart boeing-backend
            sudo systemctl restart boeing-celery
            sudo systemctl restart boeing-celery-beat

            # Wait for services to stabilize
            sleep 5

            # Verify services are running
            if systemctl is-active --quiet boeing-backend; then
              echo "âœ… Backend service is running"
            else
              echo "âŒ Backend service failed to start"
              sudo journalctl -u boeing-backend -n 20 --no-pager
              exit 1
            fi

            if systemctl is-active --quiet boeing-celery; then
              echo "âœ… Celery worker service is running"
            else
              echo "âŒ Celery worker service failed to start"
              sudo journalctl -u boeing-celery -n 20 --no-pager
              exit 1
            fi

            if systemctl is-active --quiet boeing-celery-beat; then
              echo "âœ… Celery beat service is running"
            else
              echo "âŒ Celery beat service failed to start"
              sudo journalctl -u boeing-celery-beat -n 20 --no-pager
              exit 1
            fi

            # Health check
            curl -sf http://localhost:8000/health > /dev/null && echo "âœ… Health check passed" || exit 1
            echo "ðŸš€ Deployment successful!"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
