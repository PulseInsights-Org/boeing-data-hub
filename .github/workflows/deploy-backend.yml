name: Deploy Backend to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/deploy-backend.yml'
  workflow_dispatch:  # Allow manual trigger

env:
  EC2_HOST: 98.84.57.169
  EC2_USER: ubuntu
  DEPLOY_PATH: /home/ubuntu/boeing-data-hub/backend

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ env.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy backend code to EC2
        run: |
          # Sync ONLY backend/ to EC2 (frontend is deployed on Amplify)
          rsync -avz --delete \
            --exclude '__pycache__' \
            --exclude '*.pyc' \
            --exclude '.env' \
            --exclude 'venv' \
            --exclude '.git' \
            --exclude 'celerybeat-schedule*' \
            --exclude 'tests' \
            --exclude 'logs.txt' \
            --exclude 'nul' \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            ./backend/ \
            ${{ env.EC2_USER }}@${{ env.EC2_HOST }}:${{ env.DEPLOY_PATH }}/

      - name: Install dependencies and restart services
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ env.EC2_HOST }} << 'EOF'
            cd /home/ubuntu/boeing-data-hub/backend

            # Install dependencies
            source venv/bin/activate
            pip install -r requirements.txt --quiet

            # Restart all services (stops, reloads daemon, starts with proper wait times)
            sudo bash scripts/redeploy.sh

            # Verify all 6 services are running
            SERVICES=(boeing-backend boeing-celery-extract boeing-celery-publish boeing-celery-sync boeing-celery-default boeing-celery-beat)
            ALL_OK=true

            for svc in "${SERVICES[@]}"; do
              if systemctl is-active --quiet "$svc"; then
                echo "  $svc is running"
              else
                echo "  $svc FAILED"
                sudo journalctl -u "$svc" -n 15 --no-pager
                ALL_OK=false
              fi
            done

            if [ "$ALL_OK" = false ]; then
              echo "One or more services failed to start"
              exit 1
            fi

            echo "Deployment successful!"
          EOF

      - name: Cleanup
        if: always()
        run: rm -f ~/.ssh/deploy_key
