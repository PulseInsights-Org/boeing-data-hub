{
  "type": "excalidraw",
  "version": 2,
  "source": "boeing-data-hub-scheduler-simplified",
  "elements": [
    {
      "id": "main-title",
      "type": "text",
      "x": 50,
      "y": 20,
      "width": 800,
      "height": 40,
      "text": "BOEING SYNC SCHEDULER - SIMPLIFIED FINAL DESIGN",
      "fontSize": 32,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "subtitle",
      "type": "text",
      "x": 50,
      "y": 65,
      "width": 600,
      "height": 25,
      "text": "Quick Implementation Approach - Minimal Complexity",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#868e96"
    },
    {
      "id": "section1-box",
      "type": "rectangle",
      "x": 50,
      "y": 110,
      "width": 450,
      "height": 280,
      "strokeColor": "#1971c2",
      "backgroundColor": "#e7f5ff",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section1-title",
      "type": "text",
      "x": 60,
      "y": 120,
      "width": 300,
      "height": 25,
      "text": "1. DESIGN DECISIONS",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#1971c2"
    },
    {
      "id": "section1-content",
      "type": "text",
      "x": 60,
      "y": 150,
      "width": 430,
      "height": 230,
      "text": "✓ Slot Assignment: Python hash(sku) % 1440\n  → Simple, works for single deployment\n  → May change between restarts (acceptable)\n\n✓ Dispatch: Every 1 minute (Celery Beat)\n  → Query: WHERE next_sync_at <= NOW()\n  → Simple polling, no bucket complexity\n\n✓ Rate Limiting: Celery rate_limit='2/m'\n  → Native Celery, per-worker\n  → Use single worker (concurrency=1)\n\n✓ Locking: Status-based\n  → SET status='syncing' before processing\n  → No complex DB locks needed\n\n✓ Scheduling: last_sync_at + 24h\n  → Prevents drift (explained below)",
      "fontSize": 13,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section2-box",
      "type": "rectangle",
      "x": 520,
      "y": 110,
      "width": 450,
      "height": 280,
      "strokeColor": "#2f9e44",
      "backgroundColor": "#ebfbee",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section2-title",
      "type": "text",
      "x": 530,
      "y": 120,
      "width": 400,
      "height": 25,
      "text": "2. SCHEDULING LOGIC (No Drift)",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#2f9e44"
    },
    {
      "id": "section2-content",
      "type": "text",
      "x": 530,
      "y": 150,
      "width": 430,
      "height": 230,
      "text": "WHY last_sync_at + 24h WORKS:\n\nScenario: Product assigned to slot 14:37\n\nFirst sync at 14:37:15 (small delay from queue)\n  → next_sync_at = 14:37:15 + 24h\n  → Tomorrow at 14:37:15\n\nSecond sync at 14:37:18 (another small delay)\n  → next_sync_at = 14:37:18 + 24h\n  → Day after at 14:37:18\n\nDrift Analysis:\n  → Drift is bounded by queue processing time\n  → Typically <1 minute variation\n  → ACCEPTABLE for daily sync\n\nFor FAILED sync:\n  → next_sync_at = NOW() + backoff\n  → Retries sooner, doesn't affect slot",
      "fontSize": 13,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section3-box",
      "type": "rectangle",
      "x": 50,
      "y": 410,
      "width": 920,
      "height": 200,
      "strokeColor": "#e8590c",
      "backgroundColor": "#fff4e6",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section3-title",
      "type": "text",
      "x": 60,
      "y": 420,
      "width": 300,
      "height": 25,
      "text": "3. SIMPLIFIED ARCHITECTURE",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#e8590c"
    },
    {
      "id": "arch-diagram",
      "type": "text",
      "x": 60,
      "y": 450,
      "width": 900,
      "height": 150,
      "text": "┌─────────────┐     ┌─────────────────────┐     ┌─────────────────┐     ┌─────────────────┐\n│ CELERY BEAT │────▶│ SYNC DISPATCHER     │────▶│  REDIS QUEUE    │────▶│ SYNC WORKER     │\n│ (every min) │     │ Query due products  │     │  sync_boeing    │     │ concurrency=1   │\n└─────────────┘     │ Mark as 'syncing'   │     └─────────────────┘     │ rate_limit=2/m  │\n                    │ Create batches(10)  │                             └────────┬────────┘\n                    └─────────────────────┘                                      │\n                                                                                 ▼\n┌─────────────┐     ┌─────────────────────┐     ┌─────────────────┐     ┌─────────────────┐\n│ SHOPIFY API │◀────│ SHOPIFY SYNC TASK   │◀────│ Change Detected │◀────│  BOEING API     │\n│ (if changed)│     │ rate_limit=30/m     │     │ hash compare    │     │  (10 SKUs/call) │\n└─────────────┘     └─────────────────────┘     └─────────────────┘     └─────────────────┘",
      "fontSize": 11,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section4-box",
      "type": "rectangle",
      "x": 50,
      "y": 630,
      "width": 450,
      "height": 320,
      "strokeColor": "#9c36b5",
      "backgroundColor": "#f8f0fc",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section4-title",
      "type": "text",
      "x": 60,
      "y": 640,
      "width": 300,
      "height": 25,
      "text": "4. DATABASE SCHEMA",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#9c36b5"
    },
    {
      "id": "section4-content",
      "type": "text",
      "x": 60,
      "y": 670,
      "width": 430,
      "height": 270,
      "text": "TABLE: product_sync_schedule\n─────────────────────────────────────────\nid                  UUID PRIMARY KEY\nuser_id             TEXT NOT NULL\nsku                 TEXT NOT NULL\n\n-- Scheduling --\nsync_slot           INTEGER (0-1439, minute of day)\nnext_sync_at        TIMESTAMP WITH TIME ZONE\nlast_sync_at        TIMESTAMP WITH TIME ZONE\n\n-- Status --\nsync_status         TEXT ('pending','syncing',\n                          'success','failed')\nlast_error          TEXT\nconsecutive_failures INTEGER DEFAULT 0\n\n-- Change Detection --\nlast_boeing_hash    TEXT\nlast_price          NUMERIC\nlast_quantity       INTEGER\n\n-- Control --\nis_active           BOOLEAN DEFAULT TRUE\n\nUNIQUE (user_id, sku)\nINDEX (next_sync_at, is_active, sync_status)",
      "fontSize": 11,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section5-box",
      "type": "rectangle",
      "x": 520,
      "y": 630,
      "width": 450,
      "height": 320,
      "strokeColor": "#c92a2a",
      "backgroundColor": "#fff5f5",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section5-title",
      "type": "text",
      "x": 530,
      "y": 640,
      "width": 300,
      "height": 25,
      "text": "5. TASK FLOW (Step by Step)",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#c92a2a"
    },
    {
      "id": "section5-content",
      "type": "text",
      "x": 530,
      "y": 670,
      "width": 430,
      "height": 270,
      "text": "EVERY MINUTE (Celery Beat):\n\n1. DISPATCHER runs:\n   SELECT * FROM product_sync_schedule\n   WHERE next_sync_at <= NOW()\n     AND is_active = TRUE\n     AND sync_status != 'syncing'\n   LIMIT 100\n\n2. Mark selected as 'syncing':\n   UPDATE ... SET sync_status = 'syncing'\n\n3. Group into batches of 10, queue tasks\n\n4. SYNC WORKER processes each batch:\n   - Acquire rate limit (Celery native)\n   - Call Boeing API (10 SKUs)\n   - Compare hashes for each SKU\n   - If changed → queue Shopify update\n   - Update DB:\n     * last_sync_at = NOW()\n     * next_sync_at = last_sync_at + 24h\n     * sync_status = 'success'\n\n5. SHOPIFY WORKER updates changed products",
      "fontSize": 11,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section6-box",
      "type": "rectangle",
      "x": 50,
      "y": 970,
      "width": 450,
      "height": 220,
      "strokeColor": "#0c8599",
      "backgroundColor": "#e3fafc",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section6-title",
      "type": "text",
      "x": 60,
      "y": 980,
      "width": 300,
      "height": 25,
      "text": "6. FILES TO CREATE/MODIFY",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#0c8599"
    },
    {
      "id": "section6-content",
      "type": "text",
      "x": 60,
      "y": 1010,
      "width": 430,
      "height": 170,
      "text": "NEW FILES:\n├── database/migration_005_sync_scheduler.sql\n├── backend/app/db/sync_store.py\n├── backend/app/utils/sync_helpers.py\n├── backend/celery_app/tasks/sync_dispatcher.py\n├── backend/celery_app/tasks/sync_boeing.py\n├── backend/celery_app/tasks/sync_shopify.py\n└── backend/app/routes/sync.py\n\nMODIFY:\n├── backend/celery_app/celery_config.py\n│   (Add beat_schedule, new queues)\n├── backend/celery_app/tasks/publishing.py\n│   (Add sync schedule creation after publish)\n└── backend/app/main.py\n    (Register sync router)",
      "fontSize": 11,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section7-box",
      "type": "rectangle",
      "x": 520,
      "y": 970,
      "width": 450,
      "height": 220,
      "strokeColor": "#5c940d",
      "backgroundColor": "#f4fce3",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section7-title",
      "type": "text",
      "x": 530,
      "y": 980,
      "width": 300,
      "height": 25,
      "text": "7. KEY NUMBERS",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#5c940d"
    },
    {
      "id": "section7-content",
      "type": "text",
      "x": 530,
      "y": 1010,
      "width": 430,
      "height": 170,
      "text": "Products:           1,000\nBoeing batch size:  10 SKUs/call\nBoeing rate limit:  2 calls/min (20 SKUs/min)\nShopify rate limit: 30 calls/min\n\nTime to sync all:   1000 ÷ 20 = 50 minutes\nDistributed over:   24 hours (~42/hour)\n\nDispatcher runs:    1,440/day (every minute)\nBoeing API calls:   ~100/day\nShopify updates:    ~50/day (5% change rate)\n\nWorker config:\n  sync_boeing:  concurrency=1, rate_limit=2/m\n  sync_shopify: concurrency=2, rate_limit=30/m",
      "fontSize": 11,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section8-box",
      "type": "rectangle",
      "x": 50,
      "y": 1210,
      "width": 920,
      "height": 180,
      "strokeColor": "#495057",
      "backgroundColor": "#f8f9fa",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section8-title",
      "type": "text",
      "x": 60,
      "y": 1220,
      "width": 300,
      "height": 25,
      "text": "8. TIMELINE EXAMPLE",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#495057"
    },
    {
      "id": "section8-content",
      "type": "text",
      "x": 60,
      "y": 1250,
      "width": 900,
      "height": 130,
      "text": "14:37:00  Celery Beat triggers sync_dispatcher\n14:37:01  Dispatcher queries: SELECT ... WHERE next_sync_at <= NOW() AND sync_status != 'syncing' → finds 15 products\n14:37:01  UPDATE sync_status = 'syncing' for 15 products\n14:37:02  Create 2 batches (10 + 5 SKUs), queue to sync_boeing\n14:37:02  Batch 1 starts (Celery rate_limit allows)\n14:37:03  Batch 1 Boeing API call returns, 2 changes detected → queue Shopify updates\n14:37:03  UPDATE: last_sync_at = NOW(), next_sync_at = NOW() + 24h, sync_status = 'success'\n14:37:32  Batch 2 starts (30 sec delay from rate_limit=2/m)\n14:37:33  Batch 2 completes, 0 changes\n14:37:34  Shopify updates complete (2 products)\n14:38:00  Next dispatcher run...",
      "fontSize": 11,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section9-box",
      "type": "rectangle",
      "x": 50,
      "y": 1410,
      "width": 920,
      "height": 150,
      "strokeColor": "#862e9c",
      "backgroundColor": "#f3d9fa",
      "fillStyle": "solid",
      "strokeWidth": 2,
      "roundness": { "type": 3 }
    },
    {
      "id": "section9-title",
      "type": "text",
      "x": 60,
      "y": 1420,
      "width": 400,
      "height": 25,
      "text": "9. WHAT WE'RE NOT DOING (Simplifications)",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#862e9c"
    },
    {
      "id": "section9-content",
      "type": "text",
      "x": 60,
      "y": 1450,
      "width": 900,
      "height": 100,
      "text": "✗ SHA-256 stable hashing       → Using Python hash() (simpler, acceptable for single deployment)\n✗ Hourly bucket dispatch        → Using every-minute polling (simpler, DB can handle 1440 queries/day)\n✗ Global Redis token bucket     → Using Celery native rate_limit with concurrency=1 (simpler)\n✗ FOR UPDATE SKIP LOCKED        → Using status-based locking (simpler, single worker avoids conflicts)\n✗ Anchored slot scheduling      → Using last_sync_at + 24h (simpler, minimal drift acceptable)\n✗ Catch-up dispatcher           → Dispatcher runs every minute anyway (recovers automatically)\n✗ Complex audit logging         → Basic status tracking (can add detailed logging later)",
      "fontSize": 12,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    },
    {
      "id": "section10-box",
      "type": "rectangle",
      "x": 50,
      "y": 1580,
      "width": 920,
      "height": 120,
      "strokeColor": "#2f9e44",
      "backgroundColor": "#d3f9d8",
      "fillStyle": "solid",
      "strokeWidth": 3,
      "roundness": { "type": 3 }
    },
    {
      "id": "section10-title",
      "type": "text",
      "x": 60,
      "y": 1590,
      "width": 400,
      "height": 25,
      "text": "10. IMPLEMENTATION CHECKLIST",
      "fontSize": 18,
      "fontFamily": 1,
      "textAlign": "left",
      "strokeColor": "#2f9e44"
    },
    {
      "id": "section10-content",
      "type": "text",
      "x": 60,
      "y": 1620,
      "width": 900,
      "height": 70,
      "text": "□ Create migration SQL (product_sync_schedule table)\n□ Create sync_store.py (DB operations)\n□ Create sync_helpers.py (hash calculation, slot assignment)\n□ Create sync_dispatcher.py (Celery Beat task)\n□ Create sync_boeing.py (Boeing sync task)\n□ Create sync_shopify.py (Shopify update task)\n□ Update celery_config.py (beat schedule, queues)\n□ Update publishing.py (create schedule on publish)\n□ Create backfill script for existing products\n□ Test end-to-end",
      "fontSize": 11,
      "fontFamily": 3,
      "textAlign": "left",
      "strokeColor": "#1e1e1e"
    }
  ],
  "appState": {
    "viewBackgroundColor": "#ffffff",
    "gridSize": 20
  }
}
